{% set core_subnet = IPAM.subnets | selectattr('role','equalto','core_p2p') | list | first %}
{% set loopback_subnet = IPAM.subnets | selectattr('role','equalto','core_loopback') | list | first %}
{% set oob_mgmt_subnets = IPAM.subnets | selectattr('role','equalto','oob_mgmt') | list %}

p2p_ip:
{% set core_links = core_p2p_links | dict2items %}
{%  for node in play_hosts %}
{%    set links_a = core_links | selectattr('value.node_a','equalto',node) | list  %}
{%    set links_b = core_links | selectattr('value.node_b','equalto',node) | list  %}
{%    if links_a != [] or links_b != [] %}
  {{ node }}:
{%      for l in links_a if links_a != [] %}
{%        set link_id = l.key - 1 %}
{%        set link = l.value %}
{%        set network = core_subnet.prefix | ipsubnet (IPAM.p2p_netmask, link_id) %}
    - port: {{ link.intf_a }}
      ip: {{ network | ipv4(0)| ipaddr('address') + '/' + IPAM.p2p_netmask|string }}
      peer: {{ link.node_b }}
      peer_ip: {{ network | ipv4(1)| ipaddr('address') + '/' + IPAM.p2p_netmask|string}}
      pport: {{ link.intf_b }}
{%    if link.speed is defined %}
      speed: {{ link.speed }}
{%    endif %}
{%    if link.cost is defined %}
      cost: {{ link.cost }}
{%    endif %}
{%    if link.area is defined %}
      area: {{ link.area }}
{%    endif %}
{%    if link.type is defined %}
      type: {{ link.type }}
{%    endif %}
{%      endfor %}
{%      for l in links_b if links_b != [] %}
{%        set link_id = l.key - 1 %}
{%        set link = l.value %}
{%        set network = core_subnet.prefix | ipsubnet (IPAM.p2p_netmask, link_id) %}
    - port: {{ link.intf_b }}
      ip: {{ network | ipv4(1)| ipaddr('address') + '/' + IPAM.p2p_netmask|string}}
      peer: {{ link.node_a }}
      peer_ip: {{ network | ipv4(0)| ipaddr('address') + '/' + IPAM.p2p_netmask|string}}
      pport: {{ link.intf_a }}
{%    if link.speed is defined %}
      speed: {{ link.speed }}
{%    endif %}
{%    if link.cost is defined %}
      cost: {{ link.cost }}
{%    endif %}
{%    if link.area is defined %}
      area: {{ link.area }}
{%    endif %}
{%    if link.type is defined %}
      type: {{ link.type }}
{%    endif %}
{%      endfor %}
{%    endif %}

{%  endfor %}

lo_ip:
{%  if loopback_intfs is defined %}
{%    for host in loopback_intfs %}
  {{ host.node }}: { port: {{ host.intf }}, ip: {{ loopback_subnet.prefix | ipv4(loop.index) | ipaddr('address') + '/32' }}, state: {{ state | default('up') }}}
{%    endfor %}
{%  endif %}
{%  if loopback_intf is defined %}
{%    for host in play_hosts %}
  {{ host }}: { port: {{ loopback_intf }}, ip: {{ loopback_subnet.prefix | ipv4(loop.index) | ipaddr('address') + '/32' }}, state: {{ state | default('up') }}}
{%    endfor %}
{%  endif %}

oob_mgmt_net:
{% if oob_mgmt_intfs is defined %}
{% for host in oob_mgmt_intfs %}
  {{ host.node}} : { port: {{ host.intf}}, ip: {{ hostvars[host].ansible_host + '/' + IPAM.oob_netmask|string }}}
{% endfor %}
{% endif %}
{% if oob_mgmt_intf is defined %}
{% for host in play_hosts %}
  {{ host}} : { port: {{ oob_mgmt_intf}}, ip: {{ hostvars[host].ansible_host + '/' + IPAM.oob_netmask|string }}}
{% endfor %}
{% endif %}
